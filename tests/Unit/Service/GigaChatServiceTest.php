<?php
declare(strict_types=1);

namespace Talismanfr\Tests\Unit\Service;

use GuzzleHttp\Psr7\Response;
use PHPUnit\Framework\TestCase;
use Psr\Http\Message\StreamInterface;
use Ramsey\Uuid\Uuid;
use Symfony\Component\EventDispatcher\EventDispatcher;
use Talismanfr\GigaChat\API\Auth\VO\AccessToken;
use Talismanfr\GigaChat\API\Contract\GigaChatApiInterface;
use Talismanfr\GigaChat\API\Contract\GigaChatOAuthInterface;
use Talismanfr\GigaChat\API\Requests\EmbeddingsRequest;
use Talismanfr\GigaChat\API\Requests\FilePathRequest;
use Talismanfr\GigaChat\API\Requests\LoadFileRequest;
use Talismanfr\GigaChat\API\Requests\TokensCountRequest;
use Talismanfr\GigaChat\Domain\VO\Embedding;
use Talismanfr\GigaChat\Domain\VO\FinishReason;
use Talismanfr\GigaChat\Domain\VO\FunctionCall;
use Talismanfr\GigaChat\Domain\VO\Model;
use Talismanfr\GigaChat\Domain\VO\Role;
use Talismanfr\GigaChat\Domain\VO\TokensCount;
use Talismanfr\GigaChat\Exception\ErrorDownloadFilesExeption;
use Talismanfr\GigaChat\Exception\ErrorFileInfoExeption;
use Talismanfr\GigaChat\Exception\ErrorFilesExeption;
use Talismanfr\GigaChat\Exception\ErrorGetEmbeddingsExeption;
use Talismanfr\GigaChat\Exception\ErrorGetTokensCountExeption;
use Talismanfr\GigaChat\Exception\ErrorLoadFileExeption;
use Talismanfr\GigaChat\Factory\DialogFactory;
use Talismanfr\GigaChat\Mapper\GigaChatMapper;
use Talismanfr\GigaChat\Service\Contract\GigaChatServiceInterface;
use Talismanfr\GigaChat\Service\GigaChatService;
use Talismanfr\GigaChat\Service\Response\CompletionChoiceResponse;
use Talismanfr\GigaChat\Service\Response\CompletionMessageResponse;
use Talismanfr\GigaChat\Service\Response\CompletionResponse;
use Talismanfr\GigaChat\Service\Response\FileInfoResponse;
use Talismanfr\GigaChat\Service\Response\LoadFileResponse;
use Talismanfr\Tests\Support\FunctionCallSubscriber;

class GigaChatServiceTest extends TestCase
{

    public function test__construct()
    {
        $auth = $this->createStub(GigaChatOAuthInterface::class);
        $auth->method('getAccessToken')->willReturn(new AccessToken('d', new \DateTimeImmutable('+1 day')));
        $api = $this->createStub(GigaChatApiInterface::class);
        $api->method('completions')->willReturnOnConsecutiveCalls(
            new Response(200, [], '{"choices":[{"message":{"content":"На поле должно быть 11 игроков от каждой команды.","role":"assistant"},"index":0,"finish_reason":"stop"}],"created":1726261876,"model":"GigaChat-Plus:3.1.25.3","object":"chat.completion","usage":{"prompt_tokens":24,"completion_tokens":13,"total_tokens":37}}'),
            new Response(200, [], '{"choices":[{"message":{"content":"","role":"assistant","function_call":{"name":"player_number_name","arguments":{"player_number":3,"soccer_club_name":"Спартак","soccer_league_name":"Российская Премьер-лига"}}},"index":0,"finish_reason":"function_call"}],"created":1726317018,"model":"GigaChat-Plus:3.1.25.3","object":"chat.completion","usage":{"prompt_tokens":162,"completion_tokens":49,"total_tokens":211}}'),
            new Response(200, [], '{"choices":[{"message":{"content":"","role":"assistant","function_call":{"name":"player_number_name","arguments":{"player_number":3,"soccer_club_name":"Спартак","soccer_league_name":"Российская Премьер-лига"}}},"index":0,"finish_reason":"function_call"}],"created":1726317018,"model":"GigaChat-Plus:3.1.25.3","object":"chat.completion","usage":{"prompt_tokens":162,"completion_tokens":49,"total_tokens":211}}')
        );
        $api->method('tokensCount')->willReturnOnConsecutiveCalls(
            new Response(200, [], '[{"object":"tokens","tokens":5,"characters":12},{"object":"tokens","tokens":1,"characters":5}]'),
            new Response(400, [], '')
        );
        $api->method('embeddings')->willReturnOnConsecutiveCalls(
            new Response(200, [], '{"object":"list","data":[{"usage":{"prompt_tokens":8},"object":"embedding","embedding":[0.574951171875,0.4152984619140625,-0.18428611755371094,-0.554534912109375,0.520355224609375,-0.46453857421875,-0.00386810302734375,2.972900390625,0.982177734375,-0.70489501953125,0.82855224609375,0.986572265625,-1.45556640625,-0.8907470703125,-0.9224853515625,-0.526031494140625,-0.557037353515625,1.2578125,0.62554931640625,0.27268028259277344,0.699951171875,-0.3677978515625,-0.41152191162109375,-1.5206298828125,-0.6192626953125,-0.08504176139831543,-0.550689697265625,-0.22649192810058594,0.1961669921875,-0.78070068359375,0.10375213623046875,0.4400177001953125,-1.3856201171875,-0.4635009765625,-1.19976806640625,1.2178955078125,0.43982696533203125,1.4312744140625,-0.7922744750976563,0.5946044921875,-0.3673248291015625,0.9898681640625,-0.4984130859375,-1.41015625,-0.3386383056640625,-0.24832916259765625,1.4180908203125,-0.72332763671875,-1.2412109375,0.807373046875,0.4507598876953125,0.9185791015625,0.5201416015625,-0.6260986328125,-1.19622802734375,1.6466064453125,-1.4530029296875,0.2589263916015625,-1.91064453125,0.87042236328125,-0.07745361328125,-0.71429443359375,0.31290626525878906,-1.0626220703125,-1.3160400390625,-0.1429901123046875,1.851318359375,0.54498291015625,-1.795166015625,0.34595298767089844,-0.7479248046875,0.92901611328125,-0.11083412170410156,-0.29730224609375,-0.639892578125,-0.8555908203125,0.6003875732421875,-0.08104896545410156,0.7745361328125,-0.7373046875,1.74755859375,-0.68450927734375,1.9403076171875,-0.64227294921875,0.97900390625,0.26682281494140625,0.86907958984375,0.69232177734375,1.22320556640625,0.9654541015625,-0.83929443359375,0.3703651428222656,1.3614501953125,-0.40285491943359375,-0.9534912109375,0.553619384765625,0.93829345703125,0.774169921875,-0.608795166015625,0.419036865234375,-0.3363037109375,-0.83184814453125,0.35717010498046875,-1.25885009765625,-1.19140625,0.498779296875,0.59149169921875,1.3907470703125,0.85137939453125,0.2462310791015625,0.480621337890625,1.5377197265625,0.80572509765625,-0.4241790771484375,-0.99853515625,0.05646705627441406,0.66705322265625,-1.07611083984375,-0.427093505859375,1.00347900390625,0.621795654296875,1.12841796875,-0.14461612701416016,-1.302490234375,1.25927734375,0.06621932983398438,0.2100067138671875,0.3721885681152344,-0.623931884765625,0.016094207763671875,0.9141845703125,0.59625244140625,-0.67681884765625,0.03142547607421875,-1.590087890625,-0.46380615234375,-0.3968505859375,0.08185195922851563,-1.13067626953125,0.3748016357421875,-0.04366302490234375,1.398681640625,1.02294921875,-1.76611328125,-0.90570068359375,-1.3572998046875,-1.068359375,0.14056396484375,-0.26741790771484375,-0.669219970703125,0.00162506103515625,-0.66455078125,-0.539886474609375,0.33377838134765625,1.2864990234375,-0.19479846954345703,0.21187591552734375,1.478271484375,0.64678955078125,-0.5838623046875,-0.4639892578125,-1.3922119140625,-0.07770538330078125,-0.12172877788543701,0.1800384521484375,-1.0184326171875,0.723968505859375,0.64349365234375,0.31455230712890625,-0.569488525390625,-0.4114990234375,-0.759521484375,0.709442138671875,-1.669921875,-0.22188568115234375,0.97802734375,-0.46134185791015625,0.6118011474609375,0.4653759002685547,-0.4459381103515625,0.545379638671875,2.05615234375,1.36669921875,-0.76220703125,0.009830474853515625,0.12775421142578125,0.5924072265625,0.2089986801147461,1.366943359375,1.05584716796875,0.685028076171875,-0.45086669921875,-0.6136474609375,0.3384113311767578,-0.71466064453125,0.203216552734375,0.591461181640625,0.70556640625,-0.11696243286132813,-1.3077392578125,-0.44189453125,1.0968017578125,-1.9775390625,0.040096282958984375,0.3895721435546875,-0.95318603515625,-0.617889404296875,-0.55767822265625,0.99603271484375,-2.506591796875,-2.12939453125,-0.889251708984375,0.849761962890625,0.23828697204589844,-0.5439682006835938,-0.81451416015625,-1.494384765625,-0.825531005859375,0.562957763671875,-1.01922607421875,0.22018837928771973,1.9189453125,0.25667572021484375,1.1912841796875,0.4494476318359375,0.15874099731445313,1.228271484375,0.46661376953125,2.0262451171875,1.0751953125,0.9161376953125,0.85467529296875,-2.078125,-0.443634033203125,0.3149871826171875,-0.8076171875,-0.893035888671875,0.017721176147460938,0.35579681396484375,0.655853271484375,-1.709716796875,0.07068252563476563,0.542938232421875,-0.64788818359375,-0.11859893798828125,-0.0005893707275390625,1.1204833984375,-0.63446044921875,0.18530654907226563,0.088104248046875,0.74188232421875,0.91485595703125,-1.3980712890625,-0.96002197265625,0.528411865234375,0.34931182861328125,0.79522705078125,-0.592132568359375,-0.13846588134765625,-0.7489013671875,0.7432861328125,0.917144775390625,-0.6075897216796875,1.7666015625,0.686920166015625,-0.2292938232421875,-0.0636138916015625,-0.5852890014648438,-0.432464599609375,-1.3758544921875,-0.277252197265625,-1.6632080078125,-2.390869140625,-0.22694015502929688,-0.770721435546875,0.411651611328125,-1.31982421875,-1.07305908203125,-0.10168266296386719,0.279052734375,-0.73431396484375,0.11993885040283203,1.3638916015625,-1.09149169921875,0.3872222900390625,1.280517578125,0.287445068359375,-0.11476516723632813,0.72161865234375,-0.12195205688476563,0.748291015625,-0.38916015625,2.367919921875,0.06876373291015625,0.22009658813476563,0.431884765625,-1.98828125,-2.697021484375,0.07426261901855469,-0.03141593933105469,-0.546661376953125,-1.6295166015625,0.829742431640625,0.73431396484375,-1.17120361328125,-0.6392822265625,-0.5128326416015625,-0.32697296142578125,-2.2030029296875,-0.12364983558654785,1.2786865234375,1.0672607421875,0.11252488195896149,-0.7332763671875,-1.104248046875,0.13613128662109375,-0.893035888671875,1.530517578125,-1.29412841796875,1.14276123046875,-1.03680419921875,-0.4253692626953125,-1.5501708984375,0.3116912841796875,1.1820068359375,0.47259521484375,0.71136474609375,-1.5997314453125,-0.3350830078125,-1.166015625,0.4677734375,-0.82818603515625,-0.61651611328125,1.737060546875,-0.21401214599609375,0.797119140625,-1.303466796875,0.9422607421875,0.90899658203125,-0.067901611328125,0.925537109375,-0.26629638671875,-1.89306640625,-0.3933429718017578,0.13634538650512695,-1.7032470703125,0.65081787109375,-0.552032470703125,0.641082763671875,-0.23423004150390625,0.07961273193359375,-0.01775360107421875,0.83123779296875,1.092041015625,-0.31385040283203125,2.52490234375,0.4329071044921875,-0.84222412109375,1.02734375,-0.5117340087890625,0.66558837890625,-0.2222895622253418,0.817138671875,-0.6767730712890625,-0.89892578125,0.1663203239440918,0.4476776123046875,-0.75299072265625,-1.1563720703125,-1.0726318359375,1.224365234375,0.45361328125,-0.24176025390625,1.2138671875,0.2645721435546875,-0.37883758544921875,-2.00531005859375,-0.432769775390625,0.27844715118408203,-1.04461669921875,-0.3867931365966797,-0.50653076171875,0.00572967529296875,-1.827392578125,0.3587646484375,-1.3560791015625,5.64404296875,0.4320955276489258,1.9869384765625,-1.166015625,-0.4403228759765625,-0.11862564086914063,0.23780059814453125,0.3958282470703125,-0.16844940185546875,1.0010986328125,-0.19633865356445313,0.694183349609375,1.3702392578125,-0.97967529296875,0.8924560546875,1.365966796875,1.061767578125,0.569366455078125,1.6063232421875,0.378875732421875,1.11163330078125,-0.78253173828125,0.3690204620361328,0.1691741943359375,-1.44482421875,-0.472747802734375,-0.15509414672851563,0.898895263671875,-1.322021484375,0.394683837890625,-0.884185791015625,0.3632354736328125,-1.412841796875,-0.38359832763671875,0.678497314453125,0.20026016235351563,0.27602386474609375,-1.1942138671875,0.8568115234375,0.24930191040039063,-0.9622802734375,0.02664947509765625,-0.8541259765625,0.623077392578125,0.19989013671875,1.2772216796875,0.8865966796875,-0.89825439453125,-0.11326885223388672,0.88671875,1.08258056640625,0.56298828125,-0.3335723876953125,-1.4820556640625,-0.66473388671875,-1.0321044921875,-0.723388671875,-1.2884521484375,0.3321685791015625,0.5894775390625,1.6112060546875,-0.37397003173828125,-0.8555908203125,-1.04998779296875,0.436279296875,0.12689924240112305,-1.0440673828125,-0.43947601318359375,-1.21722412109375,-0.97088623046875,-0.6983642578125,-0.86529541015625,-0.4315643310546875,0.70184326171875,0.4006805419921875,-0.44696044921875,-1.5325927734375,0.744354248046875,1.2421875,-0.453094482421875,1.09478759765625,-0.125274658203125,-0.20512771606445313,0.514434814453125,1.14703369140625,-0.513702392578125,1.15435791015625,1.1302490234375,0.019578933715820313,0.62188720703125,0.9169921875,0.07877731323242188,-1.3377685546875,1.3897705078125,0.12167143821716309,-1.8905029296875,0.972412109375,0.4149932861328125,-0.566558837890625,-1.1217041015625,-0.5372695922851563,1.01519775390625,-0.6669921875,-1.390869140625,-0.12952804565429688,-0.795379638671875,0.05063152313232422,1.6932373046875,0.649444580078125,0.724853515625,1.2406005859375,0.07511138916015625,0.5925750732421875,0.053012847900390625,1.6417236328125,-0.1310882568359375,1.3887939453125,-1.35833740234375,0.00960540771484375,1.5924072265625,0.13793563842773438,-0.10610055923461914,-1.1116943359375,3.085693359375,0.024387359619140625,1.504638671875,-1.09185791015625,0.78173828125,0.993896484375,0.5029296875,-0.08677291870117188,-1.0830078125,-1.31463623046875,0.9952392578125,0.640289306640625,-0.5260009765625,2.1500244140625,-0.028873443603515625,-0.15298795700073242,0.8568115234375,-0.5771331787109375,1.5460205078125,-1.02923583984375,1.8154296875,0.1835765838623047,-0.09961891174316406,-0.189178466796875,-1.678955078125,-0.481689453125,-0.3764801025390625,0.600067138671875,-0.80401611328125,0.6990966796875,0.819580078125,-0.5701904296875,-1.10498046875,0.1109619140625,1.12530517578125,0.87176513671875,-0.985595703125,-1.35986328125,0.27496337890625,-0.37630462646484375,2.693603515625,0.4607391357421875,1.8114013671875,-0.91632080078125,0.572113037109375,0.15717029571533203,0.16537857055664063,-0.1341686248779297,-1.4920654296875,0.33428955078125,0.7779541015625,0.78436279296875,-0.917388916015625,-1.2191162109375,1.02667236328125,-0.529144287109375,0.22443103790283203,-0.67791748046875,0.62646484375,1.8114013671875,-1.14520263671875,-1.1829833984375,-0.24485015869140625,1.186279296875,-0.31817626953125,-0.30377197265625,0.038021087646484375,-0.30454254150390625,3.47216796875,-0.78460693359375,0.08370590209960938,-0.327301025390625,-0.14411544799804688,0.958251953125,0.40869140625,-0.640716552734375,-0.7779541015625,0.043087005615234375,-1.058349609375,-0.262237548828125,0.057415008544921875,-0.24834823608398438,-0.387603759765625,0.03550529479980469,0.73260498046875,0.9312744140625,0.71044921875,-0.122802734375,-0.09522247314453125,0.17649078369140625,0.661285400390625,0.94219970703125,1.40789794921875,0.5435333251953125,1.23486328125,0.81842041015625,-0.53753662109375,0.638031005859375,0.24855804443359375,0.06194448471069336,-1.260009765625,-0.9410400390625,-0.6031494140625,0.66162109375,0.75531005859375,-1.1573486328125,-0.50537109375,-0.0140228271484375,-0.276519775390625,-0.3098106384277344,-1.007293701171875,-0.37127685546875,-0.56573486328125,0.81036376953125,0.07204437255859375,0.610626220703125,-0.57696533203125,0.534881591796875,-0.2231903076171875,0.63592529296875,-0.55584716796875,-0.46430206298828125,0.629425048828125,-2.349609375,-0.738189697265625,0.423065185546875,-0.26818084716796875,0.22531890869140625,-0.665435791015625,0.8682861328125,1.37548828125,-0.2226696014404297,-0.655548095703125,-0.1140751838684082,-1.1904296875,-1.15234375,-0.4062042236328125,0.1697235107421875,0.6064453125,-0.651947021484375,0.17249298095703125,-0.5144195556640625,1.57470703125,0.80084228515625,-0.752532958984375,-0.5048828125,-2.010986328125,0.89935302734375,-0.27584075927734375,-0.663116455078125,-2.1453857421875,2.599853515625,0.773681640625,-0.694488525390625,-1.06219482421875,-0.84100341796875,-0.517974853515625,-0.639617919921875,0.5521240234375,0.2388763427734375,0.20491313934326172,0.609161376953125,0.486297607421875,-1.3436279296875,1.1666259765625,-0.0331573486328125,-1.229736328125,-0.5060882568359375,0.346954345703125,-0.75103759765625,-0.259796142578125,-0.333160400390625,-1.9874267578125,-1.17181396484375,0.2125244140625,-0.1515864133834839,-0.76611328125,0.59832763671875,-0.462432861328125,-0.40472412109375,-1.5078125,0.2976703643798828,0.4499053955078125,-0.390045166015625,-0.16300201416015625,1.1337890625,0.7537841796875,0.08800888061523438,-1.203369140625,-0.16548919677734375,-0.073211669921875,-0.20327377319335938,0.08961296081542969,0.09786510467529297,-1.12689208984375,-0.660247802734375,1.415771484375,-1.72021484375,-0.304290771484375,-0.1078033447265625,0.222137451171875,0.1352977752685547,0.591796875,0.98529052734375,-0.30146026611328125,0.4461669921875,-0.4610595703125,0.99945068359375,-0.73834228515625,-0.594085693359375,-0.23997879028320313,-0.5264015197753906,-0.0747833251953125,-1.2437744140625,-0.74609375,-0.71038818359375,-1.3251953125,0.28284454345703125,0.05893874168395996,1.8175048828125,-1.06817626953125,1.0777587890625,-0.32169342041015625,-0.2562103271484375,0.77691650390625,-0.94281005859375,-0.68505859375,-1.656005859375,1.68505859375,-0.375335693359375,0.026926040649414063,-0.765289306640625,1.05743408203125,-0.82781982421875,0.67474365234375,1.01397705078125,-1.45556640625,-1.1861572265625,-0.06240081787109375,0.4578399658203125,-0.32213592529296875,-1.31878662109375,0.14732742309570313,-0.4419097900390625,1.05487060546875,-0.78857421875,0.01546478271484375,-0.95428466796875,0.42034912109375,-1.9122314453125,-1.609375,-1.276611328125,0.4344635009765625,-1.014404296875,0.10621261596679688,0.24034500122070313,0.5977783203125,0.3690948486328125,-2.013671875,-0.73431396484375,-0.11706399917602539,0.94171142578125,0.02542567253112793,-0.378509521484375,0.95123291015625,0.5543212890625,0.70269775390625,-0.3669319152832031,1.9893798828125,-0.5708770751953125,0.31749534606933594,-2.2862548828125,0.1153116226196289,-0.2918853759765625,-0.141387939453125,-0.84765625,-0.70977783203125,-1.6446533203125,0.020404815673828125,0.852813720703125,-1.4013671875,0.4012451171875,-0.2323455810546875,0.8797607421875,-0.2536048889160156,-0.3625335693359375,1.3458251953125,0.7613525390625,-0.68402099609375,0.5970611572265625,-0.21407699584960938,1.333984375,-0.626739501953125,0.005588531494140625,0.0944061279296875,0.632171630859375,0.5352935791015625,0.67950439453125,0.516571044921875,-1.1119384765625,-0.9766845703125,-0.18843460083007813,-0.680328369140625,0.7196807861328125,0.701324462890625,-1.01666259765625,0.81768798828125,-0.29882049560546875,-0.3686065673828125,-0.7166748046875,0.3907012939453125,-0.89031982421875,0.600677490234375,-1.277099609375,0.05206632614135742,-0.4140625,1.2843017578125,-0.1515979766845703,-0.94927978515625,0.46405029296875,-1.1357421875,-1.3057861328125,-0.3119964599609375,0.11135673522949219,1.231201171875,0.98175048828125,1.8427734375,0.459686279296875,-1.53955078125,-0.01303863525390625,1.301025390625,1.1251220703125,-0.35805511474609375,-0.685882568359375,-0.43798828125,0.08390045166015625,-0.747039794921875,-1.07879638671875,-0.53900146484375,-0.2791748046875,1.04388427734375,-0.29498863220214844,-1.0089111328125,0.12789154052734375,-0.03191947937011719,0.91326904296875,-0.06951141357421875,-0.5766143798828125,0.11048316955566406,0.56170654296875,0.284942626953125,-1.43017578125,-0.524627685546875,0.775146484375,0.5158233642578125,-0.08188724517822266,0.25430727005004883,0.13140106201171875,-1.25518798828125,-1.04327392578125,-0.020063400268554688,-1.2987060546875,0.028057098388671875,-0.061174869537353516,-0.4979248046875,-0.74102783203125,-0.10816478729248047,-0.64678955078125,-0.538543701171875,0.16181182861328125,1.478271484375,0.24277305603027344,-0.7166748046875,0.77288818359375,0.02649831771850586,0.0051116943359375,1.06494140625,0.89111328125,-0.2328338623046875,1.326171875,-0.877685546875,-1.08953857421875,-0.19809627532958984,-0.57391357421875,-0.914154052734375,-1.3214111328125,0.612335205078125,-0.432373046875,0.52655029296875,-1.4332275390625,-0.05927467346191406,-0.24203872680664063,-1.6668701171875,1.39288330078125,-0.41956329345703125,-0.26231956481933594,-0.46502685546875,0.89422607421875,-1.20654296875,-0.3099937438964844,-1.01318359375,0.51263427734375,-2.33203125,0.4716796875,-0.63800048828125,-0.84619140625,-0.3585662841796875,-0.95745849609375,1.27154541015625,-0.05200958251953125,0.75994873046875,-0.31494140625,-1.1689453125,-0.3839855194091797,-0.81524658203125,-1.267333984375,0.845703125,-0.99420166015625,-1.26214599609375,-0.590362548828125,-1.3160400390625,-0.21457290649414063,-1.08233642578125,-0.885986328125,1.81787109375,0.3272132873535156,0.19528961181640625,-0.262176513671875,-0.521240234375,0.887054443359375,0.97021484375,0.847900390625,0.5250244140625,-1.2252197265625,-0.247955322265625,-0.61993408203125,-0.85772705078125,0.47601318359375,0.823486328125,-1.2208251953125,-0.75457763671875,0.912567138671875,0.81573486328125,-1.814697265625,0.3629302978515625,0.6553955078125,-0.03814697265625,0.801910400390625,0.56781005859375,0.0259552001953125,0.63238525390625,0.491790771484375,0.2785911560058594,0.353668212890625,0.5970458984375,1.3651123046875,2.1507568359375,0.5699462890625,0.37103271484375,0.03954315185546875,0.26861572265625,-0.476654052734375,0.2539386749267578,-1.09722900390625,0.630859375,0.516448974609375,-0.707763671875,-0.51763916015625,1.01617431640625,-0.940185546875,-0.8343505859375,1.25390625,-0.16009902954101563,1.9666748046875,-0.729736328125,-0.93328857421875,-0.5590057373046875,-0.3190460205078125,-0.3564605712890625,-0.2380809783935547,1.8880615234375,1.93212890625,-0.623443603515625,1.01348876953125,1.1658935546875,-0.41767120361328125,0.7886962890625,1.04010009765625,-0.054859161376953125,-0.05430081486701965,0.5550994873046875,-0.33753204345703125,1.0716552734375,0.00658416748046875,-0.009622573852539063,-0.567535400390625,1.3570556640625,-0.683837890625,-0.0004634857177734375,-0.853271484375,-0.767578125,0.976318359375,0.82598876953125,0.20803451538085938,0.661529541015625,-0.39014434814453125,-1.0963134765625,0.96502685546875,0.4198150634765625,0.17470550537109375,0.9412841796875,0.87060546875,-0.219451904296875,-1.3055419921875,0.680328369140625],"index":0},{"usage":{"prompt_tokens":10},"object":"embedding","embedding":[-0.16645105183124542,0.07176687568426132,-0.056776296347379684,-1.0689772367477417,0.5773248672485352,-0.23248106241226196,-0.4793934226036072,2.7967779636383057,0.6612520813941956,-0.6343665719032288,0.5418598651885986,0.7399560213088989,-1.6896264553070068,-0.6430497169494629,-0.8804978728294373,-0.3764675259590149,-0.31740981340408325,0.8436416387557983,0.27778860926628113,-0.19091102480888367,0.6752257347106934,-0.46240538358688354,-0.6920673251152039,-1.1833536624908447,-0.8610690236091614,-0.08636374026536942,-0.8518671989440918,-0.6638271808624268,-0.5119721293449402,-2.128288745880127,0.048013024032115936,0.4725896716117859,-0.5775933265686035,-0.7588722705841064,-0.5989503860473633,0.1999359130859375,0.5506833791732788,1.1499145030975342,-0.5743577480316162,1.1967291831970215,-0.205301895737648,1.4179154634475708,0.1622711718082428,-1.3319989442825317,-0.636734127998352,-0.3985171914100647,1.807273507118225,-0.00913320854306221,0.04410544037818909,-0.17030753195285797,0.21558456122875214,-0.12739808857440948,0.37524405121803284,-0.8972906470298767,-1.367146611213684,1.3721258640289307,-0.6870880722999573,1.1920428276062012,-2.160898208618164,0.3847937285900116,0.06260983645915985,-0.5386623740196228,0.5330119132995605,-0.2664954662322998,-1.0154746770858765,1.528679370880127,1.9165241718292236,0.4352452754974365,-1.827776312828064,0.5321027040481567,-0.5509152412414551,0.5356968641281128,-0.43535512685775757,-0.33229494094848633,-0.5098608732223511,-0.5016475319862366,0.9450085163116455,-0.319502055644989,0.11775994300842285,-0.6811568737030029,2.5051498413085938,-0.8219672441482544,1.303002119064331,0.043104708194732666,1.1272637844085693,0.9091529846191406,0.6293995380401611,0.6660604476928711,0.99321448802948,0.3882489800453186,0.018190138041973114,0.9069074392318726,1.009763240814209,-0.15751004219055176,-1.4862581491470337,0.19219550490379333,0.5264949798583984,0.958579421043396,0.08398675173521042,0.6905052065849304,0.47337377071380615,-0.5786672830581665,1.001903772354126,-0.6437392830848694,-1.3409323692321777,1.0932388305664063,1.4548205137252808,0.7256772518157959,1.0938735008239746,0.2669941186904907,0.6606724262237549,1.183060646057129,1.0570173263549805,-0.8491578698158264,-0.8593604564666748,0.49371716380119324,0.5312316417694092,-0.32067060470581055,0.3340492844581604,0.6426653265953064,0.6001464128494263,1.777788519859314,-0.20504635572433472,-0.8804246187210083,0.4702587127685547,-0.4862093925476074,0.5343177318572998,-0.013863809406757355,-0.8296313881874084,0.7393214106559753,1.0477421283721924,0.6022943258285522,-0.8984622359275818,-0.010776177048683167,-1.9751036167144775,-0.7923358082771301,-0.5383939146995544,-0.08150475472211838,-1.238857626914978,0.49920061230659485,-0.4919971823692322,1.7369781732559204,0.9978520274162292,-1.1030998229980469,-0.46329018473625183,-1.2157187461853027,-0.717085599899292,0.4375762343406677,-0.3403160572052002,-0.3842811584472656,0.8447644114494324,-1.1164753437042236,-1.0617036819458008,-0.09403374046087265,0.8614107370376587,-0.37263697385787964,0.4149560332298279,0.9044666290283203,0.2716987729072571,-0.0783347487449646,-0.6061508059501648,-1.2381742000579834,-0.36849522590637207,-0.9243836402893066,0.39343419671058655,-1.5097875595092773,0.952989935874939,0.5138515830039978,0.529155433177948,-0.9581644535064697,-0.10921710729598999,-1.3636318445205688,1.3214058876037598,-1.8121551275253296,-0.1787191778421402,0.4913473129272461,-0.15441176295280457,0.9566511511802673,1.5869171619415283,-0.6726140975952148,0.5469001531600952,1.4166462421417236,1.6489137411117554,-1.1828166246414185,0.05637051537632942,1.111886739730835,1.0491089820861816,0.4837563633918762,1.5022698640823364,1.273614764213562,0.3932816684246063,-0.6004637479782104,-0.2713387608528137,0.3014339506626129,-1.0693190097808838,0.5761776566505432,0.5322186946868896,0.8161824941635132,-0.4451305568218231,-1.333365797996521,-0.025580834597349167,0.7614107131958008,-1.4852818250656128,-0.04600927233695984,0.6519404053688049,-0.645508885383606,-1.0861849784851074,-1.181107997894287,1.0040028095245361,-2.145179271697998,-2.3175981044769287,-1.0300219058990479,0.7524041533470154,0.8547229170799255,-1.3965339660644531,-1.3164753913879395,-1.3890650272369385,-0.6616883873939514,0.7567243576049805,-0.6719550490379333,0.25552383065223694,1.821234941482544,0.29597264528274536,0.7560653686523438,1.407175898551941,1.1950695514678955,0.27986252307891846,0.4561820924282074,0.6587014198303223,1.5531363487243652,0.8934829831123352,0.3378325402736664,-1.645301342010498,-0.272736132144928,0.8067854046821594,-0.1269068717956543,-1.3547472953796387,-0.16043978929519653,0.05770532786846161,0.5577739477157593,-1.148864984512329,0.770405113697052,0.1558329463005066,-0.3720618486404419,-0.26543810963630676,0.35270166397094727,0.01621212810277939,-0.29903584718704224,1.0847936868667603,0.15224744379520416,0.997607946395874,1.4242615699768066,-0.9349279403686523,-0.58664870262146,0.6452525854110718,0.3866548538208008,0.7461068630218506,-0.51308274269104,-1.131608486175537,-0.5113741159439087,0.31681716442108154,1.0814741849899292,-0.9178910851478577,1.156407117843628,0.9644129276275635,-0.086809903383255,0.14358675479888916,-0.8413228988647461,-0.2927568852901459,-0.742201566696167,-0.5701732635498047,-1.838711142539978,-1.4742982387542725,0.21613985300064087,-0.25292590260505676,0.45078712701797485,-1.198974847793579,-0.22193066775798798,-0.8570050597190857,0.34578651189804077,-0.9005125164985657,0.09815718233585358,0.9012447595596313,-0.771369218826294,-0.08693251013755798,1.6451060771942139,0.13611939549446106,-0.3557046055793762,-0.3482242822647095,-0.11849217861890793,0.85306316614151,-0.11026130616664886,1.8195751905441284,0.4165852665901184,-0.13215461373329163,0.5208323001861572,-0.9477666020393372,-2.8967535495758057,-0.7232364416122437,0.6604344248771667,-0.39001399278640747,-1.9997069835662842,0.5468146800994873,0.6939711570739746,-1.0546741485595703,-0.1728450208902359,-0.18260464072227478,-0.19297388195991516,-2.100170612335205,0.7783499956130981,0.7905296087265015,1.135660171508789,0.45474734902381897,-1.153282880783081,-1.4209420680999756,-0.07367280125617981,-0.8574322462081909,1.2543811798095703,-0.9396631121635437,0.25502803921699524,-0.9994141459465027,-0.14174318313598633,-1.1974127292633057,0.1558510661125183,1.0425188541412354,0.24538685381412506,1.2202098369598389,-1.1797411441802979,0.5008542537689209,-0.9231876134872437,0.23005247116088867,-0.8308273553848267,-0.5016292333602905,1.0523797273635864,-0.19832193851470947,0.9705637693405151,-1.0513546466827393,1.200927495956421,1.0403220653533936,-0.5946545600891113,0.6885281801223755,-0.7796924114227295,-1.475616216659546,-0.5552806854248047,0.08327892422676086,-1.7360994815826416,0.36633530259132385,-1.0166462659835815,0.8800585269927979,0.44993284344673157,-0.2251754254102707,0.17198559641838074,0.8551622629165649,1.1857455968856812,-0.774932861328125,2.6251401901245117,1.0013668537139893,-0.8461312651634216,0.8376860618591309,-0.7354893684387207,1.3940931558609009,-0.7518671751022339,1.0015132427215576,-0.651037335395813,-0.9972174167633057,-0.24473775923252106,0.37318310141563416,-0.6663656234741211,-1.0684890747070313,-0.520527184009552,0.9572857618331909,0.782377302646637,0.06421619653701782,0.0548434853553772,0.758554995059967,-0.6242371797561646,-1.5890650749206543,-1.0060043334960938,0.07069273293018341,-0.8089333176612854,-1.0545276403427124,-0.20505400002002716,-0.34502682089805603,-1.3612886667251587,0.07885647565126419,-1.3945813179016113,5.744593620300293,-0.09509548544883728,1.258286476135254,-0.8119111061096191,0.05717187747359276,1.0206491947174072,0.7136440873146057,0.23091894388198853,0.05336831510066986,1.1052964925765991,-0.6366609334945679,0.6872589588165283,1.2896264791488647,-1.1407370567321777,0.7732486724853516,0.36579203605651855,1.465852975845337,0.4083353281021118,1.4683425426483154,-0.43058332800865173,0.9157431721687317,-1.0779106616973877,0.19236482679843903,0.7044666409492493,-2.04764461517334,-0.7113497257232666,-0.26706963777542114,0.6644861698150635,-1.699487328529358,0.43926042318344116,-0.5695203542709351,0.09559127688407898,-0.8897729516029358,-0.018297210335731506,0.8947033882141113,0.26836708188056946,0.08676470071077347,-0.7098852396011353,1.721356987953186,0.07488711178302765,-0.5146738290786743,0.5478886365890503,-0.3197888433933258,0.8063948750495911,0.4215218126773834,0.8781546950340271,1.041054368019104,-0.18236513435840607,-0.6698681712150574,0.7195264101028442,0.8305100798606873,0.900903046131134,-0.7984133958816528,-1.258384108543396,-1.0467658042907715,-1.2571148872375488,-0.5745667219161987,-1.3791553974151611,-0.6089088916778564,0.4548083543777466,1.6383694410324097,1.1241395473480225,-1.4064435958862305,-0.08920475840568542,1.5870147943496704,0.7024407386779785,-1.1691480875015259,-0.5099340677261353,-0.5655845403671265,-0.5529075860977173,-1.0853794813156128,-0.3679887652397156,-0.7343665361404419,0.5945569276809692,0.2994630038738251,-1.0802538394927979,-1.305882215499878,1.3099340200424194,0.9615327715873718,-0.7111056447029114,0.8115205764770508,-0.08740389347076416,-0.8274834752082825,0.907395601272583,1.0478886365890503,-0.7296558022499084,1.4013667106628418,0.8285086154937744,-0.8312667608261108,1.0185989141464233,1.009274959564209,0.8303636312484741,-1.1522088050842285,0.7554307579994202,0.8011227250099182,-1.3630460500717163,1.3171100616455078,0.18221411108970642,-1.0206491947174072,-1.6400291919708252,-0.3434952199459076,1.1069073677062988,-1.2144007682800293,-0.7950206995010376,-0.2959299087524414,-1.082255244255066,-0.2726888358592987,1.2659506797790527,0.7761288285255432,-0.02517695724964142,0.6088601350784302,-0.22447827458381653,0.40048202872276306,-0.27177202701568604,0.4733463227748871,-0.013757778331637383,1.5769586563110352,-1.3351231813430786,0.21435041725635529,0.3996216654777527,-0.41950204968452454,0.134220153093338,-0.6605076789855957,2.0155234336853027,-0.14745545387268066,1.7663655281066895,-0.8457895517349243,0.24026724696159363,0.8441298007965088,0.5512813925743103,0.28082436323165894,-1.069514274597168,-1.609470248222351,1.7827677726745605,0.7411520481109619,-0.6121674180030823,1.5296069383621216,-0.5212228298187256,0.3965096175670624,1.0914326906204224,-0.9818159341812134,1.13639235496521,-1.1956064701080322,0.9614351391792297,0.07402367144823074,-0.5840126276016235,0.058539018034935,-1.1131070852279663,-0.3180619776248932,-0.14493530988693237,0.3986087143421173,-0.6360697746276855,0.5939711332321167,0.4310593008995056,-1.0022454261779785,-1.2891383171081543,0.2183419167995453,1.2357333898544312,0.9463021159172058,-1.1272637844085693,-1.0375396013259888,-0.33004024624824524,-0.54011470079422,2.7305831909179688,1.1242371797561646,2.163534164428711,-1.8818646669387817,0.6246765851974487,0.14355015754699707,0.8511593341827393,-0.34392234683036804,-1.4069806337356567,0.31090429425239563,0.737808108329773,1.3853062391281128,-0.6622772216796875,-1.1939467191696167,1.0888454914093018,-0.7371369004249573,-0.08046130836009979,-0.5994141697883606,0.4601598381996155,0.9032950401306152,-0.25867247581481934,-0.7418598532676697,0.3479863107204437,-0.06793384999036789,-1.2148888111114502,-0.09633877873420715,-0.11492860317230225,-0.14717170596122742,3.6432509422302246,-1.033292531967163,-0.3682084083557129,-0.5532572865486145,-0.3827129602432251,1.3448864221572876,0.4503050744533539,-0.5926287174224854,-1.3194043636322021,0.7027092576026917,-1.9380033016204834,-0.4466560482978821,0.2101842761039734,-0.6418110132217407,-0.37980836629867554,0.09182175248861313,0.8721014857292175,1.03666090965271,0.7387599945068359,0.11296146363019943,-0.6907737255096436,0.8597021698951721,0.7788869142532349,0.8862581849098206,1.5242371559143066,1.4556992053985596,0.7072491645812988,0.35620343685150146,-0.8485720753669739,0.2797077000141144,0.31240540742874146,0.7531852126121521,-0.873834490776062,-1.2259701490402222,-0.10198315232992172,0.4193364977836609,0.42831337451934814,-0.6643275022506714,-0.7942396402359009,0.09038320183753967,-0.01675616204738617,-0.08216682821512222,-1.5264827013015747,-1.3471319675445557,-0.9285573959350586,0.9607028961181641,0.617354154586792,-0.013900414109230042,-0.4252013564109802,0.4791047275066376,0.02875274419784546,1.1129851341247559,-0.7960946559906006,-0.05234012380242348,0.5385769605636597,-1.4273858070373535,-0.7525994181632996,0.4650460481643677,-0.0003157779574394226,0.43326517939567566,-0.6714668869972229,1.2299730777740479,1.1123260259628296,-0.3413015604019165,-0.931266725063324,-0.1757604479789734,-1.0403220653533936,-1.366804838180542,-0.7473028898239136,-0.24993896484375,0.8222601413726807,-0.8554795980453491,0.4215477406978607,-1.7334634065628052,1.1628996133804321,1.4188917875289917,-0.22220830619335175,-0.33758845925331116,-1.2877225875854492,0.6494019627571106,0.18268243968486786,-1.1310714483261108,-1.8334389925003052,1.6574077606201172,0.13939350843429565,-0.5392360091209412,-0.9979984760284424,-1.0359774827957153,-0.4543629288673401,-0.7159384489059448,0.8474004864692688,-0.13381846249103546,0.005170702934265137,0.46466922760009766,0.19983524084091187,-0.7220404744148254,0.513985812664032,0.8099584579467773,-1.1395654678344727,-1.2308517694473267,0.3075786828994751,-0.136856809258461,-0.12341956794261932,-0.10165287554264069,-1.318281650543213,-1.3244812488555908,0.5933365821838379,-0.7256528735160828,-0.9244812726974487,-0.09846838563680649,-0.5797656774520874,-1.1382474899291992,-1.097339391708374,0.06415516883134842,0.39043810963630676,-0.4545520842075348,0.32068586349487305,1.3810104131698608,0.896460771560669,-0.574981689453125,-1.8025871515274048,-0.337380975484848,0.5742493867874146,-0.31618255376815796,0.40854281187057495,0.4444471299648285,-0.5611544847488403,-1.323700189590454,1.2652671337127686,-0.8366609215736389,0.12552475929260254,-0.21238557994365692,0.6851598024368286,0.6693922281265259,0.8456919193267822,0.49526479840278625,0.14383846521377563,0.28373199701309204,0.02997162565588951,0.33328044414520264,-0.2539297044277191,-0.7038075923919678,-1.2286550998687744,-0.5875396132469177,-0.16948910057544708,-0.7083841562271118,-0.7968757152557373,-0.6960702538490295,-1.2720526456832886,0.14877043664455414,-0.1280815154314041,1.224798560142517,-0.9016352891921997,0.9915059208869934,0.3081812858581543,-0.3063308298587799,-0.14188353717327118,-0.7464607954025269,-0.7592872381210327,-0.9188185930252075,0.9696362614631653,-0.45264825224876404,0.21164265275001526,-0.7422991991043091,2.012106418609619,-0.7822918891906738,-0.07567884027957916,0.21549303829669952,-1.0515499114990234,-1.6784963607788086,0.4065611958503723,-0.009979862719774246,-0.7977544069290161,-1.541029930114746,0.15944898128509521,-0.5602391958236694,-0.10221350193023682,-1.5024651288986206,0.520527184009552,-0.7078349590301514,0.01597186177968979,-1.1218940019607544,-0.8213326334953308,-0.7573345899581909,0.9677812457084656,-0.9896020889282227,0.3473028838634491,1.1834511756896973,1.208542823791504,-0.39692455530166626,-1.300903081893921,-0.8851842284202576,-0.4090324938297272,0.9653160572052002,-0.005189772695302963,-0.4069563150405884,0.654234766960144,0.22623564302921295,0.7740052938461304,-0.4913167953491211,0.619489848613739,-1.317158818244934,0.377687931060791,-1.8622405529022217,0.0022760629653930664,0.11156637966632843,-0.6425920724868774,-0.6949962973594666,-0.9305832982063293,-1.1153526306152344,-0.21332260966300964,0.6880643963813782,-1.0896753072738647,0.459140807390213,0.3107769191265106,0.7752501368522644,0.19771477580070496,0.07687026262283325,0.8623382449150085,1.3712471723556519,-0.35710275173187256,0.4132169485092163,0.2290029227733612,1.3140345811843872,-0.8513301610946655,0.20766718685626984,0.5864046812057495,0.8333414196968079,1.2246520519256592,1.0522820949554443,0.5072003602981567,-0.9419574737548828,-1.1072003841400146,-0.6245300769805908,-0.9735415577888489,0.10183364897966385,1.1579692363739014,-1.6694165468215942,0.8881620168685913,-0.29694896936416626,-0.14449749886989594,-0.7860873341560364,0.5855991840362549,-0.9555528163909912,0.4899316430091858,-0.2564471662044525,-0.41480350494384766,-0.13480594754219055,1.2752745151519775,0.25246673822402954,-0.70303875207901,0.5213692784309387,-1.0220649242401123,-0.9477177858352661,-0.07937667518854141,0.3865267038345337,1.303246259689331,1.1629972457885742,1.1896021366119385,0.9083231091499329,-1.0103490352630615,0.40117764472961426,0.7786428928375244,0.21858066320419312,-0.6208078861236572,-1.4358798265457153,-0.9800341129302979,-0.20796923339366913,-0.9072979688644409,-1.0863070487976074,-1.1236026287078857,-0.8852818608283997,1.0724432468414307,-0.20018000900745392,-1.2491090297698975,0.056786976754665375,0.3229176700115204,0.8641444444656372,-0.2662481367588043,-0.7271906137466431,0.10183746367692947,0.7723699808120728,0.21027275919914246,-0.7856235504150391,-0.8608737587928772,0.645569920539856,0.6800829172134399,-0.8828410506248474,0.6602147817611694,-0.10721106082201004,-0.5934708118438721,-1.2732242345809937,0.37119537591934204,-1.413717269897461,-0.5262752771377563,-0.029979251325130463,-0.7123565673828125,-0.4136196970939636,-1.188040018081665,-1.5877958536148071,-0.3186858892440796,-0.3477879762649536,0.9071027040481567,-0.7850377559661865,-0.8542347550392151,-0.13263362646102905,0.20538806915283203,0.3155220150947571,0.8151817917823792,1.6519403457641602,-0.34535330533981323,1.1999022960662842,-1.2588722705841064,-0.9716865420341492,-1.038808822631836,-0.4737429618835449,-0.6413961052894592,-1.5933609008789063,0.2639320492744446,0.3161505162715912,0.23027366399765015,-0.6035025119781494,0.37625089287757874,-0.20749631524085999,-1.4221136569976807,1.0927019119262695,-0.3373565673828125,0.3890121579170227,-1.0034170150756836,0.6627776026725769,-0.8871368765830994,-0.15260249376296997,-0.9960946440696716,0.3448193669319153,-2.640761375427246,-0.1432877629995346,-0.4863070249557495,-1.0462777614593506,-0.7021783590316772,-0.5049670338630676,1.4375395774841309,-0.10352696478366852,1.0484256744384766,-0.27208930253982544,-0.9817426800727844,-0.32833778858184814,-0.8966315984725952,-0.5840981006622314,0.4011227488517761,-0.6379789710044861,-1.5370270013809204,0.18149711191654205,-1.4447643756866455,0.13913992047309875,-0.9709054827690125,-1.448474407196045,0.9337929487228394,0.32028883695602417,0.037753231823444366,-0.013043079525232315,0.017817914485931396,1.5385891199111938,0.43252527713775635,0.342851459980011,-0.26584237813949585,-0.7318037152290344,0.17245543003082275,0.3735572099685669,-0.8924090266227722,0.7118134498596191,0.47199776768684387,-0.8596289157867432,-0.17626310884952545,0.02509763091802597,1.2318280935287476,-1.9567487239837646,0.5084329843521118,0.9220404624938965,0.3911886513233185,1.2644373178482056,0.14509090781211853,1.4991456270217896,0.7277519702911377,0.2424975335597992,-0.07182389497756958,0.014467902481555939,0.38193798065185547,2.2143030166625977,1.748401165008545,1.3003660440444946,1.1531851291656494,-0.1556169092655182,0.8455454707145691,0.004338540136814117,0.2345893234014511,-0.8687819838523865,0.5179277062416077,0.5928239822387695,-0.5155967473983765,-1.1971685886383057,1.1045154333114624,-0.3979741036891937,-0.12613610923290253,0.40845736861228943,-0.4866304397583008,1.6031241416931152,-1.119013786315918,-0.7080546617507935,-0.6962655186653137,-1.323700189590454,-0.295521080493927,-0.24712592363357544,1.1744202375411987,1.8340247869491577,-0.7101781368255615,0.760702908039093,0.28944501280784607,0.544520378112793,0.9786184430122375,0.9000976085662842,0.01678743213415146,0.07853306829929352,0.517305314540863,0.17885340750217438,1.2215278148651123,-0.29052048921585083,0.016414448618888855,-0.19194072484970093,0.7285330295562744,-0.42115265130996704,0.3426043391227722,-1.5585061311721802,-0.22512203454971313,0.9851598143577576,0.39201050996780396,0.8328288793563843,0.6880887746810913,-0.9166218638420105,-0.9176958203315735,0.9505003094673157,0.39211463928222656,0.5915547609329224,0.8988039493560791,0.5622894763946533,-0.12893903255462646,-1.4330484867095947,0.38892480731010437],"index":1}],"model":"Embeddings"}'),
            new Response(400, [], '')
        );
        $api->method('loadFile')->willReturnOnConsecutiveCalls(
            new Response(200, [], '{"id":"b6360f95-3272-409c-ad1a-32ec737f2952","object":"file","bytes":5005,"access_policy":"private","created_at":1730926110,"filename":"giga.jpeg","purpose":"general"}'),
            new Response(400, [], '')
        );
        $api->method('fileInfo')->willReturnOnConsecutiveCalls(
            new Response(200, [], '{"id":"b6360f95-3272-409c-ad1a-32ec737f2952","object":"file","bytes":5005,"access_policy":"private","created_at":1730926110,"filename":"giga.jpeg","purpose":"general"}'),
            new Response(400, [], '')
        );
        $api->method('files')->willReturnOnConsecutiveCalls(
            new Response(200, [], '{"data":[{"id":"81fe1cb5-4263-4a6c-9896-8662f1d59e86","object":"file","bytes":5005,"access_policy":"private","created_at":1730926898,"filename":"giga.jpeg","purpose":"general"},{"id":"ef105435-22ec-4839-bfbf-37243ee9f781","object":"file","bytes":5005,"access_policy":"private","created_at":1730926828,"filename":"giga.jpeg","purpose":"general"},{"id":"b6360f95-3272-409c-ad1a-32ec737f2952","object":"file","bytes":5005,"access_policy":"private","created_at":1730926110,"filename":"giga.jpeg","purpose":"general"},{"id":"6a1c35f6-8c2e-42ba-be5d-2238c4a1c616","object":"file","bytes":42453,"access_policy":"private","created_at":1726148345,"filename":"6a1c35f6-8c2e-42ba-be5d-2238c4a1c616","purpose":"text2image"},{"id":"238a97f4-7e86-4d0c-8186-d4aa7cb53ff9","object":"file","bytes":31536,"access_policy":"private","created_at":1726148291,"filename":"238a97f4-7e86-4d0c-8186-d4aa7cb53ff9","purpose":"text2image"},{"id":"90a969ac-ee7e-40c3-bc4d-ec8348adf051","object":"file","bytes":36019,"access_policy":"private","created_at":1726148238,"filename":"90a969ac-ee7e-40c3-bc4d-ec8348adf051","purpose":"text2image"},{"id":"161d3619-25df-4982-9c6a-df9ed8cf650e","object":"file","bytes":33439,"access_policy":"private","created_at":1726148212,"filename":"161d3619-25df-4982-9c6a-df9ed8cf650e","purpose":"text2image"},{"id":"a91bae60-89f2-48ef-9e10-0bf8bc0878bb","object":"file","bytes":49790,"access_policy":"private","created_at":1726148156,"filename":"a91bae60-89f2-48ef-9e10-0bf8bc0878bb","purpose":"text2image"},{"id":"03e467bd-2be5-42bb-b320-5822b1cbe40b","object":"file","bytes":58978,"access_policy":"private","created_at":1726146569,"filename":"03e467bd-2be5-42bb-b320-5822b1cbe40b","purpose":"text2image"},{"id":"6421ef84-1a64-430c-b80b-a43f043ba910","object":"file","bytes":40846,"access_policy":"private","created_at":1726146396,"filename":"6421ef84-1a64-430c-b80b-a43f043ba910","purpose":"text2image"},{"id":"865ed922-dbf6-4da4-8794-1f45c50700d3","object":"file","bytes":33509,"access_policy":"private","created_at":1726145302,"filename":"865ed922-dbf6-4da4-8794-1f45c50700d3","purpose":"text2image"}]}'),
            new Response(400, [], '')
        );
        $api->method('downloadFile')->willReturnOnConsecutiveCalls(
            new Response(200, [], 'body content'),
            new Response(400, [], '')
        );

        $service = new GigaChatService($api, new GigaChatMapper());

        self::assertInstanceOf(GigaChatServiceInterface::class, $service);

        return $service;
    }

    /**
     * @depends test__construct
     */
    public function testCompletions(GigaChatService $service)
    {
        $factory = new DialogFactory();
        $dialog = $factory->dialogBase('test', 'test', Model::createGigaChatPlus());
        $result = $service->completions($dialog);

        self::assertInstanceOf(CompletionResponse::class, $result);
        $choice = $result->choices[0];
        self::assertInstanceOf(CompletionChoiceResponse::class, $choice);
        $message = $choice->message;
        self::assertInstanceOf(CompletionMessageResponse::class, $message);
        self::assertEquals('На поле должно быть 11 игроков от каждой команды.', $message->content);
        self::assertEquals(Role::ASSISTANT, $message->role);

        self::assertEquals(0, $choice->index);
        self::assertEquals(FinishReason::STOP, $choice->finish_reason);
        self::assertEquals('GigaChat-Plus:3.1.25.3', $result->model);
        self::assertEquals(24, $result->usage->getPromptTokens());
        self::assertEquals(13, $result->usage->getCompletionTokens());
        self::assertEquals(37, $result->usage->getTotalTokens());

        $result = $service->completions($dialog);

        self::assertInstanceOf(FunctionCall::class, $result->choices[0]->message->function_call);
        self::assertEquals('player_number_name', $result->choices[0]->message->function_call->getName());
        self::assertEquals(['player_number' => 3, 'soccer_club_name' => 'Спартак', 'soccer_league_name' => 'Российская Премьер-лига'], $result->choices[0]->message->function_call->getArguments());

        $message = $dialog->getMessages()->getMessages()[3];

        self::assertInstanceOf(FunctionCall::class, $message->getFunctionCall());

        $responseFunctionMessage = $message->buildFunctionResult(json_encode(['player_number_name' => 'Всеволод Михайлович Бобров'], JSON_UNESCAPED_UNICODE));
        $dialog->addMessage($responseFunctionMessage);
        self::assertEquals(Role::FUNCTION, $responseFunctionMessage->getRole());


        // test eventdisparcher
        $ed = new EventDispatcher();
        $dialog->setEventDispatcher($ed);
        $ed->addSubscriber(new FunctionCallSubscriber());
        $service->completions($dialog);

        $message = $dialog->getMessages()->getLastMessage();
        self::assertEquals(Role::FUNCTION, $message->getRole());
        self::assertEquals('player_number_name', $message->getName());

    }

    //[{"object":"tokens","tokens":5,"characters":12},{"object":"tokens","tokens":1,"characters":5}]


    /**
     * @depends test__construct
     */
    public function testTokensCount(GigaChatService $service)
    {
        $result = $service->tokensCount(new TokensCountRequest(Model::createGigaChat(), ['ds']));
        self::assertIsArray($result);
        self::assertCount(2, $result);
        foreach ($result as $item) {
            self::assertInstanceOf(TokensCount::class, $item);
        }
        $tokens = $result[0];
        self::assertEquals(5, $tokens->getTokens());
        self::assertEquals(12, $tokens->getCharacters());
        self::expectException(ErrorGetTokensCountExeption::class);

        $service->tokensCount(new TokensCountRequest(Model::createGigaChat(), ['ds']));

    }

    /**
     * @depends test__construct
     */
    public function testEmbeddings(GigaChatService $service)
    {
        $result = $service->embeddings(new EmbeddingsRequest(Model::createEmbeddings(), ['sd']));
        self::assertIsArray($result);
        self::assertCount(2, $result);
        foreach ($result as $item) {
            self::assertInstanceOf(Embedding::class, $item);
        }
        $emb = $result[0];
        self::assertEquals(8, $emb->getPromtTokens());
        foreach ($emb->getEmbedding() as $float) {
            self::assertIsFloat($float);
        }

        self::expectException(ErrorGetEmbeddingsExeption::class);
        $service->embeddings(new EmbeddingsRequest(Model::createEmbeddings(), ['sd']));
    }

    /**
     * @depends test__construct
     */
    public function testLoadFile(GigaChatService $service)
    {
        $load = $service->loadFile(new LoadFileRequest(new FilePathRequest(__DIR__ . '/../../Support/giga.jpeg')));
        self::assertInstanceOf(LoadFileResponse::class, $load);
        self::assertEquals('b6360f95-3272-409c-ad1a-32ec737f2952', $load->id->toString());
        self::assertEquals(5005, $load->bytes);

        self::expectException(ErrorLoadFileExeption::class);
        $service->loadFile(new LoadFileRequest(new FilePathRequest(__DIR__ . '/../../Support/giga.jpeg')));
    }

    /**
     * @depends test__construct
     */
    public function testFileInfo(GigaChatService $service)
    {
        $info = $service->fileInfo(Uuid::fromString('b6360f95-3272-409c-ad1a-32ec737f2952'));
        self::assertInstanceOf(FileInfoResponse::class, $info);
        self::assertEquals('b6360f95-3272-409c-ad1a-32ec737f2952', $info->id->toString());
        self::assertEquals(5005, $info->bytes);

        self::expectException(ErrorFileInfoExeption::class);
        $service->fileInfo(Uuid::fromString('b6360f95-3272-409c-ad1a-32ec737f2952'));
    }

    /**
     * @depends test__construct
     */
    public function testFiles(GigaChatService $service)
    {
        $files = $service->files();
        self::assertCount(11, $files->files);
        self::assertInstanceOf(FileInfoResponse::class, $files->files[0]);
        self::assertEquals('81fe1cb5-4263-4a6c-9896-8662f1d59e86', $files->files[0]->id->toString());
        self::assertEquals(5005, $files->files[0]->bytes);

        self::expectException(ErrorFilesExeption::class);
        $service->files();
    }

    /**
     * @depends test__construct
     */
    public function testDownloadFile(GigaChatService $service)
    {
        $stream = $service->downloadFile(Uuid::fromString('81fe1cb5-4263-4a6c-9896-8662f1d59e86'));
        self::assertInstanceOf(StreamInterface::class, $stream);

        self::expectException(ErrorDownloadFilesExeption::class);
        $service->downloadFile(Uuid::fromString('b6360f95-3272-409c-ad1a-32ec737f2952'));
    }
}
